# Система бронирования отелей

Итоговый проект по дисциплине "Фреймворк Spring и работа с REST API". 1-й семестр 2-го курса МИФИ ИИКС РПО (2025-2026 уч. г).

Подробное описание задания находится в файле [task.md](task.md).

## Описание проекта

Микросервисная система бронирования отелей на базе Spring Boot с использованием Spring Cloud. Система включает 4 сервиса:

- **Eureka Server** (порт 8761) - сервис регистрации и обнаружения
- **API Gateway** (порт 8080) - маршрутизация запросов и проксирование JWT
- **Hotel Service** (порт 8081) - управление отелями и номерами
- **Booking Service** (порт 8082) - бронирования, аутентификация и авторизация

## Предусловия

- Java 21
- WSL2/Ubuntu (рекомендуется)
- Maven (встроен в проект как `./mvnw`)

## Переменные окружения

```bash
# JWT секрет (обязательно)
export SECURITY_JWT_SECRET="your-secret-key-here-at-least-32-characters"

# Bootstrap админ (опционально)
export BOOTSTRAP_ADMIN_USER="admin"
export BOOTSTRAP_ADMIN_PASS="admin"
```

## Запуск системы

### 1. Eureka Server
```bash
cd eureka-server
./mvnw spring-boot:run
```

### 2. Hotel Service
```bash
cd hotel-service
./mvnw spring-boot:run
```

### 3. Booking Service
```bash
cd booking-service
./mvnw spring-boot:run
```

### 4. API Gateway
```bash
cd api-gateway
./mvnw spring-boot:run
```

**Порядок запуска важен!** Сначала Eureka, затем сервисы, в конце Gateway.

## Как пользоваться системой

### 1. Регистрация пользователя
```bash
curl -X POST http://localhost:8080/api/user/register \
  -H "Content-Type: application/json" \
  -d '{"username": "testuser", "password": "testpass"}'
```

### 2. Авторизация
```bash
curl -X POST http://localhost:8080/api/user/auth \
  -H "Content-Type: application/json" \
  -d '{"username": "testuser", "password": "testpass"}'
```

Сохраните полученный токен в переменную:
```bash
TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

### 3. Просмотр отелей
```bash
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8080/api/hotels
```

### 4. Просмотр доступных номеров
```bash
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8080/api/rooms
```

### 5. Просмотр рекомендованных номеров (сортировка по популярности)
```bash
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8080/api/rooms/recommend
```

### 6. Создание бронирования
```bash
curl -X POST http://localhost:8080/api/booking \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "roomId": 1,
    "startDate": "2025-12-01",
    "endDate": "2025-12-05"
  }'
```

### 7. Просмотр истории бронирований
```bash
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8080/api/booking
```


## Административные операции

### Авторизация администратора
```bash
curl -X POST http://localhost:8080/api/user/auth \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "admin"}'
```

### Создание отеля (только ADMIN)
```bash
curl -X POST http://localhost:8080/api/hotels \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Новый отель",
    "address": "Москва, ул. Примерная, 1"
  }'
```

### Создание номера (только ADMIN)
```bash
curl -X POST http://localhost:8080/api/rooms \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "hotelId": 1,
    "number": "101"
  }'
```


## Проверка системы

### 1. Проверка Eureka
Откройте http://localhost:8761 - должны быть зарегистрированы все сервисы.

### 2. Проверка Gateway
```bash
curl http://localhost:8080/actuator/health
```

## Решение возможных проблем

### Порт уже занят
```bash
# Найти процесс на порту
lsof -i :8080
# Завершить процесс
kill -9 <PID>
```

### JWT секрет не задан
```bash
export SECURITY_JWT_SECRET="your-secret-key-here-at-least-32-characters"
```

### Eureka недоступна
- Проверьте, что Eureka Server запущен первым
- Убедитесь, что порт 8761 свободен
- Проверьте логи сервисов на ошибки подключения

### Нет администратора
- Система автоматически создает админа при первом запуске
- Логин: `admin`, пароль: `admin` (либо можно использовать переменные окружения `BOOTSTRAP_ADMIN_USER`/`BOOTSTRAP_ADMIN_PASS`)

### H2 консоль недоступна
- H2 консоль отключена в production режиме
- Для разработки включите в `application.yml`:
```yaml
spring:
  h2:
    console:
      enabled: true
```

### Сервисы не регистрируются в Eureka
- Проверьте, что Eureka Server запущен
- Убедитесь, что все сервисы имеют правильные настройки Eureka
- Проверьте логи на ошибки подключения

### Gateway не маршрутизирует запросы
- Убедитесь, что Gateway запущен последним
- Проверьте, что все сервисы зарегистрированы в Eureka

### Curl команды зависают или возвращают 401
- Убедитесь, что токен правильно сохранен в переменной
- Проверьте, что все сервисы запущены
- Убедитесь, что JWT секрет задан

## Тестирование

### Запуск интеграционных тестов
```bash
# Booking Service
cd booking-service && ./mvnw test -Dtest=BookingIntegrationTest

# Hotel Service
cd hotel-service && ./mvnw test -Dtest=HotelIntegrationTest
```

## Соответствие критериям оценивания

### Критерий 1. Алгоритм планирования занятости номеров
**Требовалось**: Сортировка доступных номеров по возрастанию times_booked, предотвращение простоя
**Реализовано**: Эндпойнт `/api/rooms/recommend` возвращает номера, отсортированные по популярности. Счетчик `times_booked` инкрементируется при каждом бронировании. Идемпотентность предотвращает дублирование операций через `X-Request-Id`.

### Критерий 2. Согласованность данных между сервисами
**Требовалось**: Сага с компенсацией, устойчивость вызовов, двухшаговое подтверждение
**Реализовано**: Бронирование создается в статусе PENDING, при успешном подтверждении переходит в CONFIRMED, при сбое - в CANCELLED. Настроены повторы и таймауты для вызовов Hotel Service. При недоступности Hotel Service выполняется компенсация.

### Критерий 3. Booking Service (CRUD бронирований)
**Требовалось**: CRUD бронирований с проверкой прав доступа, идемпотентность, валидация дат
**Реализовано**: Полный CRUD с проверкой прав доступа. Пользователи видят только свои бронирования. Повторные запросы с одинаковым `X-Request-Id` не создают дубликатов. Валидация дат через `@Future` аннотации.

### Критерий 4. Hotel Service (CRUD отелей и номеров)
**Требовалось**: CRUD отелей и номеров, статистика загруженности
**Реализовано**: CRUD отелей и номеров с ролевой авторизацией. Счетчик `times_booked` для каждого номера. Админ-операции доступны только пользователям с ролью ADMIN.

### Критерий 5. Gateway + Eureka
**Требовалось**: Маршрутизация через Gateway, интеграция с Eureka
**Реализовано**: Маршрутизация через Gateway с динамическим обнаружением. Все запросы проходят через Gateway (порт 8080). Сервисы автоматически регистрируются и обнаруживаются в Eureka.

### Критерий 6. Безопасность (JWT, роли)
**Требовалось**: JWT аутентификация, ролевая авторизация, методная безопасность
**Реализовано**: JWT аутентификация с ролевой авторизацией. Каждый сервис валидирует JWT независимо. USER для пользовательских операций, ADMIN для административных. Методная безопасность через `@PreAuthorize`.

### Критерий 7. Тестирование
**Требовалось**: Интеграционные сценарии, проверка авторизации, бизнес-логики
**Реализовано**: 23 интеграционных теста. Покрытие включает параллельные брони, компенсацию, негативные кейсы. Все тесты проходят успешно.

### Критерий 8. Структура баз данных
**Требовалось**: Минимальная схема согласно ТЗ
**Реализовано**: Таблицы users, bookings, hotels, rooms с внешними ключами между ними. Структура соответствует минимальной схеме.

### Критерий 9. Предзаполнение данных
**Требовалось**: Предзаполнение с учетом сценариев тестирования
**Реализовано**: Автоматическое создание админа и тестовых данных при первом запуске. Настройка через переменные окружения.

### Критерий 10. Качество кода
**Требовалось**: SOLID принципы, выделение сервисов, отсутствие дублирования
**Реализовано**: Код структурирован по слоям, зависимости через интерфейсы. Выделены сервисы и контроллеры. Отсутствует дублирование кода.

### Критерий 11. Код-стиль и читаемость
**Требовалось**: Единый стиль, осмысленные имена, структура пакетов
**Реализовано**: Единый стиль кодирования, осмысленные имена. Код читаем и структурирован по пакетам. Короткие методы с четкой ответственностью.

### Критерий 12. Обработка ошибок
**Требовалось**: Централизованная обработка, корректные статусы
**Реализовано**: Централизованный обработчик ошибок. Корректные HTTP статусы (401, 403, 409). Ошибки логируются с контекстом.

### Критерий 13. Логирование и трассировка
**Требовалось**: Структурные логи, корреляция запросов
**Реализовано**: Структурное логирование с корреляцией. Логи содержат `bookingId` и `requestId`. Ключевые шаги процесса логируются.

### Критерий 14. Документация разработчика
**Требовалось**: README с инструкциями запуска
**Реализовано**: Подробный README с инструкциями. Описаны все этапы запуска и использования. Готовые curl команды для тестирования.

### Критерий 15. Поддерживаемость тестов
**Требовалось**: Читаемые тесты, независимость от окружения
**Реализовано**: Читаемые тесты с AAA структурой. Тесты независимы от окружения. Все основные сценарии покрыты тестами.